<?xml version="1.0" encoding="utf-8"?>

<!--
//****  Filename: SearchApp_Ant.xml
//****  Author: uri w.
//****  Date: 9.10.11
//****  Description: Conduit Abstraction Layer Project Build Settings
//****  Realcommerce & Conduit (c)
-->

<project name="SearchApp" default="prod" xmlns:rsel="antlib:org.apache.tools.ant.types.resources.selectors">
    <!-- Project dir. (basedir), build dir. (builddir) and development tools dir. (devToolsDir) are set via the command line. e.g. -Dbasedir="c:\" etc. -->
    <description>JS Build - Abstraction Layer Project</description>

    <!-- Adding Ant Contrib (sits in lib/ant-contrib-1.0b3.jar) -->
    <taskdef resource="net/sf/antcontrib/antcontrib.properties"/>

    <!-- Classpath for Preprocess task -->
    <path id="js-build-tasks.classpath">
        <pathelement location="."/>
        <fileset dir="${devToolsDir}\lib">
            <include name="**/*.jar"/>
        </fileset>
    </path>

    <!-- Adding Pre Process Ant task -->
    <taskdef name="preprocess" classname="com.moxiecode.ant.tasks.PreProcessTask" classpathref="js-build-tasks.classpath" loaderref="js-build-tasks.classpath.loader" />

    <!-- Global Variables And Initialization -->
    <target name="-define.global.properties"
        description="Sets global properties for this build">
        <echo message="Defining Apache-Ant Global Properties..."/>

        <!-- Project's base Source Dir. -->
        <property name="srcdir" value="js"/>
    </target>
  
    <!-- Copy files and media into the extension build dir. -->
    <target name="-copy.files" depends="-define.global.properties">
        <echo message="Copying files into build dir..."/>

        <!-- Copying all files in 'main\js' dir. except files which end with .js, .csproj, etc. -->
        <copy todir="${builddir}\tb\al\wa\SEARCH\js\" includeEmptyDirs="false">
            <fileset dir="${srcdir}" excludes="**\*.exe,**\*.html,**\*.com,**\*.bat,**\*.scc,**\*.cs,**\*.txt,**\*.bak,**\*.csproj,**\*.user,**\*.ps1,**\*.bat,**\*.vspscc,**\*.dll,**\*.pdb,**\*.cache,**\*.sln,**\*.suo,**\*.vssscc"/>
        </copy>

      <copy todir="${builddir}\tb\al\wa\SEARCH\Css" includeEmptyDirs="false">
        <fileset dir="${srcdir}\..\Css" excludes="**\*.exe,**\*.com,**\*.bat,**\*.scc,**\*.cs,**\*.txt,**\*.js,**\*.bak,**\*.csproj,**\*.user,**\*.ps1,**\*.bat,**\*.vspscc,**\*.dll,**\*.pdb,**\*.cache,**\*.sln,**\*.suo,**\*.vssscc"/>
      </copy>

      <copy todir="${builddir}\tb\al\wa\SEARCH\resources" includeEmptyDirs="false">
        <fileset dir="${srcdir}\..\resources" excludes="**\*.exe,**\*.com,**\*.bat,**\*.scc,**\*.cs,**\*.txt,**\*.js,**\*.bak,**\*.csproj,**\*.user,**\*.ps1,**\*.bat,**\*.vspscc,**\*.dll,**\*.pdb,**\*.cache,**\*.sln,**\*.suo,**\*.vssscc"/>
      </copy>

      <copy todir="${builddir}\tb\al\wa\SEARCH\" includeEmptyDirs="false">
        <fileset dir="${srcdir}\..\">
          <include name="**/*.html"/>
        </fileset>
      </copy>

    </target>

  <!-- Create build dirs -->
  <target name="-init" depends="-define.global.properties"
      description="Creates SEARCH directory structure">
    <!--Delete previous build files-->
    <delete dir="${builddir}\tb\al\wa\SEARCH"/>
    <!--Recreate build dirs-->
    <mkdir dir="${builddir}\tb\al\wa\SEARCH"/>
  </target>

  <!-- Preprocessing all js / html files in build dir. -->
    <target name="-preprocess.files" description="Runs Preprocessing Ant task on all js files">
        <!-- Process pre proccesing instuctions like #if/#endif etc -->
        <preprocess infile="${foreach.file}" outfile="${foreach.file}.prep" defines="ABST_ATP_TESTER,NPAPI_TESTER,ABST_JASMINE"/>
        <copy file="${foreach.file}.prep" tofile="${foreach.file}"/>
        <delete file="${foreach.file}.prep"></delete>
    </target>

    <!-- Build -->
    <target name="prod"
        description="Builds files for production"
        depends="
            -define.global.properties,
            -init,
			      -copy.files">
        <echo message="Finished building to ${builddir}\tb\al\wa\SEARCH"/>
    </target>
</project>
